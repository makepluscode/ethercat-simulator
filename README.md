# EtherCAT Simulator

A lightweight EtherCAT simulator and scaffolding for experiments and integration. It provides a core simulation library, optional KickCAT master linkage via Conan, and small examples/tests to validate the toolchain.

## Project Layout
- Core: `include/`, `core/` (simulation, adapters)
- Communication (planned FastDDS): `include/communication/`, `core/communication/`
- Examples: `examples/hello/`, `examples/kickcat_scan/`
- Docs: `PRD.md`, `AGENTS.md`
- Tests: `tests/` (GoogleTest via CTest)

## Prerequisites
- Linux/WSL
- CMake ≥ 3.20, C++17 toolchain (`build-essential` or similar)
- Optional: Conan v2 (for GTest, KickCAT)

## Build (CMake only)
```
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build -j
ctest --test-dir build --output-on-failure
```

## Build with Conan (GTest/KickCAT)
```
# 1) Detect profile and install deps (GTest always, KickCAT optional)
conan profile detect
export KICKCAT_REF=kickcat/v2.0-rc1  # optional, enables KickCAT
conan install . -of build -s build_type=Release \
  -o ethercat-simulator*:with_kickcat=True --build=missing

# 2) Configure with Conan toolchain and CMakeDeps
cmake -S . -B build \
  -DCMAKE_TOOLCHAIN_FILE=build/conan_toolchain.cmake \
  -DCMAKE_PREFIX_PATH=$PWD/build

# 3) Build & test
cmake --build build -j
ctest --test-dir build --output-on-failure
```
Notes
- `-DCMAKE_PREFIX_PATH=$PWD/build` lets CMake find `GTest`/`kickcat` configs generated by Conan (CMakeDeps).

### KickCAT Vendored Fallback (libs/kickcat)
- 미러링 스크립트로 Conan 캐시의 KickCAT 산출물을 `libs/kickcat`에 복사합니다.
```
bash tools/sync_kickcat.sh
```
- CMake는 `find_package(kickcat CONFIG)` 실패 시 `libs/kickcat`의 정적 라이브러리와 헤더를 자동 사용합니다.

## Run Examples
- Hello: `build/examples/hello/examples_hello`
- KickCAT scan: `build/examples/kickcat_scan/examples_kickcat_scan`
  - Uses a simulated socket layered over the internal `NetworkSimulator`. Current loopback stub reports 0 detected slaves; extend simulator for real discovery behavior.

## Coding Style
- C++17+, 4-space indent, LF, UTF-8. Use `clang-format` (LLVM, 100 cols).
- Conventions and contribution rules: see `AGENTS.md`.

## Troubleshooting
- “Could not find GTest/kickcat”: ensure Conan step ran and pass `-DCMAKE_PREFIX_PATH=$PWD/build` on configure.
- Network/permissions: the simulator runs unprivileged; real NIC access (future) may require capabilities.

## Architecture Overview
```
Examples/Apps ──▶ KickCAT Master (Conan)
                 │
                 └──▶ SimSocket (Adapter)
                       │
                       └──▶ NetworkSimulator (Core)
                              ├──▶ Virtual Slaves (planned)
                              └──▶ Communication/FastDDS (planned)
```
- Adapter: `SimSocket` implements KickCAT `AbstractSocket`, bridging KickCAT frames to the simulator.
- Core: `NetworkSimulator` provides loopback today; extend to parse datagrams and emulate slaves.
- Extensibility: add fault injection (delay/drop/corrupt), timing, and DDS-based distribution.
